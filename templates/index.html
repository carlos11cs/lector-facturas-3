<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Lector de Facturas</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}" />
</head>
<body data-user-role="{{ user.role }}">
  <div class="app-shell">
    <aside class="sidebar" id="sidebar">
      <div class="sidebar-brand">
        <span class="brand-mark" aria-hidden="true">
          <svg viewBox="0 0 40 40" role="img" focusable="false">
            <rect x="4" y="4" width="32" height="32" rx="8"></rect>
            <rect x="12" y="10" width="6" height="6" rx="2" fill="var(--panel)"></rect>
            <rect x="12" y="20" width="6" height="6" rx="2" fill="var(--panel)"></rect>
            <rect x="22" y="10" width="12" height="16" rx="3" fill="var(--panel)"></rect>
          </svg>
        </span>
        <div>
          <span class="brand-title">Ledged</span>
          <span class="brand-subtitle">Panel contable-fiscal</span>
        </div>
      </div>
      <nav class="sidebar-nav">
        <button class="nav-link active" data-section="dashboard" type="button">Dashboard</button>
        <button class="nav-link" data-section="companies" type="button">Mis empresas</button>
        <button class="nav-link" data-section="invoices" type="button">Facturas</button>
        <button class="nav-link" data-section="expenses" type="button">Gastos (sin factura)</button>
        <button class="nav-link" data-section="income" type="button">Ingresos</button>
        <button class="nav-link" data-section="payments" type="button">Calendario de pagos</button>
        <button class="nav-link" data-section="reports" type="button">Informes</button>
        <button class="nav-link" data-section="taxes" type="button">Modelos de impuestos</button>
        <button class="nav-link" data-section="pnl" type="button">Pérdidas y Ganancias</button>
        {% if user and user.role == "owner" %}
        <a class="nav-link" href="{{ url_for('admin_dashboard') }}">Panel de gestorías</a>
        {% endif %}
      </nav>
    </aside>

    <div class="sidebar-overlay" id="sidebarOverlay"></div>

    <main class="main">
      <header class="topbar">
        <div class="title-block">
          <button class="hamburger" id="sidebarToggle" type="button" aria-label="Mostrar menú">☰</button>
          <span class="brand-mark" aria-hidden="true">
            <svg viewBox="0 0 40 40" role="img" focusable="false">
              <rect x="4" y="4" width="32" height="32" rx="8"></rect>
              <rect x="12" y="10" width="6" height="6" rx="2" fill="var(--panel)"></rect>
              <rect x="12" y="20" width="6" height="6" rx="2" fill="var(--panel)"></rect>
              <rect x="22" y="10" width="12" height="16" rx="3" fill="var(--panel)"></rect>
            </svg>
          </span>
          <div>
            <p class="tag">Panel fiscal</p>
            <h1>Control contable</h1>
            <p class="subtitle">Visión global de ingresos, gastos e impuestos con IA.</p>
          </div>
        </div>
        <div class="filters">
          <div class="field">
            <label for="monthSelect">Mes</label>
            <select id="monthSelect"></select>
          </div>
          <div class="field">
            <label for="yearSelect">Año</label>
            <select id="yearSelect"></select>
          </div>
          <div class="field">
            <label for="periodSelect">Periodo</label>
            <select id="periodSelect">
              <option value="monthly">Mensual</option>
              <option value="quarterly">Trimestral</option>
            </select>
          </div>
          <div class="field">
            <label for="companySelect">Empresa</label>
            <select id="companySelect"></select>
          </div>
        </div>
        <div class="topbar-meta">
          <div class="context">
            <span id="headerCompanyLabel">Empresa: -</span>
            <span id="headerPeriodLabel">Periodo: -</span>
          </div>
          <div class="user-info">
            <span id="headerUserEmail">{{ user.email }}</span>
            <a class="button ghost" href="{{ url_for('logout') }}">Cerrar sesión</a>
          </div>
        </div>
      </header>

      <div class="global-processing" id="globalProcessing" role="status" aria-live="polite">
        <span class="spinner"></span>
        <span id="globalProcessingText">Procesando factura… Puede tardar hasta 2 minutos.</span>
      </div>

      <section class="page-section active" data-section="dashboard">
        <section class="panel summary-panel">
          <div class="summary-item highlight">
            <h3>Total gastado</h3>
            <p id="totalSpent">0,00 €</p>
          </div>
          <div class="summary-item">
            <h3>IVA 0%</h3>
            <p id="vat0">0,00 €</p>
          </div>
          <div class="summary-item">
            <h3>IVA 4%</h3>
            <p id="vat4">0,00 €</p>
          </div>
          <div class="summary-item">
            <h3>IVA 10%</h3>
            <p id="vat10">0,00 €</p>
          </div>
          <div class="summary-item">
            <h3>IVA 21%</h3>
            <p id="vat21">0,00 €</p>
          </div>
          <div class="summary-item total">
            <h3>Total IVA deducible</h3>
            <p id="vatTotal">0,00 €</p>
          </div>
          <p class="empty dashboard-empty" id="dashboardEmptyMessage">
            No hay datos para el periodo seleccionado.
          </p>
        </section>

        <section class="grid dashboard-grid">
          <div class="panel">
            <div class="panel-header">
              <h2>Evolución de gastos</h2>
              <p>Seguimiento del gasto en el periodo seleccionado.</p>
            </div>
            <div class="chart-wrapper">
              <canvas id="lineChart"></canvas>
              <p class="chart-empty" id="lineChartEmpty">No hay gastos en el periodo seleccionado.</p>
            </div>
          </div>
          <div class="panel">
            <div class="panel-header">
              <h2>Evolución de facturación</h2>
              <p>Base facturada consolidada por periodo.</p>
            </div>
            <div class="chart-wrapper">
              <canvas id="billingLineChart"></canvas>
              <p class="chart-empty" id="billingChartEmpty">No hay ingresos en el periodo seleccionado.</p>
            </div>
          </div>
          <div class="panel">
            <div class="panel-header">
              <h2>Distribución por proveedor</h2>
              <p>Porcentaje del gasto total por proveedor.</p>
            </div>
            <div class="chart-wrapper">
              <canvas id="pieChart"></canvas>
              <p class="chart-empty" id="pieChartEmpty">No hay gastos para mostrar.</p>
            </div>
          </div>
          <div class="panel">
            <div class="panel-header">
              <h2>Resultado neto</h2>
              <p>Ingresos menos gastos deducibles.</p>
            </div>
            <div class="chart-wrapper">
              <canvas id="netChart"></canvas>
              <p class="chart-empty" id="netChartEmpty">No hay datos suficientes para el resultado neto.</p>
            </div>
          </div>
        </section>
      </section>

      <section class="page-section" data-section="companies">
        <section class="panel companies-panel">
          <div class="panel-header">
            <div>
              <h2>Mis empresas</h2>
              <p>Gestiona tus empresas y selecciona cuál usar en el panel.</p>
            </div>
          </div>
          <div class="billing-form">
            <div class="field">
              <label for="companyDisplayName">Nombre comercial</label>
              <input type="text" id="companyDisplayName" placeholder="Ej. Estudio Norte" />
            </div>
            <div class="field">
              <label for="companyLegalName">Razón social</label>
              <input type="text" id="companyLegalName" placeholder="Ej. Estudio Norte SL" />
            </div>
            <div class="field">
              <label for="companyTaxId">CIF / NIF</label>
              <input type="text" id="companyTaxId" placeholder="Ej. B12345678" />
            </div>
            <div class="field">
              <label for="companyEmail">Email de la empresa</label>
              <input type="email" id="companyEmail" placeholder="Ej. facturacion@empresa.com" />
            </div>
            <div class="field">
              <label for="companyPhone">Teléfono</label>
              <input type="text" id="companyPhone" placeholder="Ej. 900 123 456" />
            </div>
            <div class="field">
              <label for="companyAssignedSelect">Asignar a trabajador</label>
              <select id="companyAssignedSelect">
                <option value="">Sin asignar</option>
              </select>
            </div>
            <div class="field">
              <label for="companyType">Tipo de empresa</label>
              <select id="companyType">
                <option value="individual">Autónomo</option>
                <option value="company">Sociedad</option>
              </select>
            </div>
            <button id="companySaveBtn" class="button primary">Guardar empresa</button>
          </div>
          <div class="billing-entries">
            <h3>Empresas registradas</h3>
            <div class="billing-table">
              <table id="companiesTable">
                <thead>
                  <tr>
                    <th>Nombre comercial</th>
                    <th>Razón social</th>
                    <th>CIF/NIF</th>
                    <th>Email</th>
                    <th>Teléfono</th>
                    <th>Asignado a</th>
                    <th>Tipo</th>
                    <th>Acciones</th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>
            <p class="empty" id="companiesEmpty">No hay empresas registradas.</p>
          </div>
        </section>

        <section class="panel staff-panel">
          <div class="panel-header">
            <div>
              <h2>Equipo de la gestoría</h2>
              <p>Crea usuarios trabajadores y asigna empresas.</p>
            </div>
          </div>
          <div class="billing-form">
            <div class="field">
              <label for="staffEmail">Email del trabajador</label>
              <input type="email" id="staffEmail" placeholder="Ej. asesor@gestoria.com" />
            </div>
            <div class="field">
              <label for="staffPassword">Contraseña temporal</label>
              <input type="password" id="staffPassword" placeholder="Mínimo 8 caracteres" />
            </div>
            <button id="staffSaveBtn" class="button primary">Crear trabajador</button>
          </div>
          <div class="billing-entries">
            <h3>Trabajadores</h3>
            <div class="billing-table">
              <table id="staffTable">
                <thead>
                  <tr>
                    <th>Email</th>
                    <th>Estado</th>
                    <th>Acciones</th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>
            <p class="empty" id="staffEmpty">No hay trabajadores creados.</p>
          </div>
        </section>
      </section>

      <section class="page-section" data-section="invoices">
        <section class="panel upload-panel">
          <div class="panel-header">
            <div>
              <h2>Subir facturas</h2>
              <p>Arrastra archivos o selecciona una carpeta completa. Añade los datos antes de guardar.</p>
            </div>
            <button id="uploadBtn" class="button primary">Guardar facturas</button>
          </div>
          <div class="upload-area" id="dropZone">
            <div class="upload-copy">
              <h3>Arrastra y suelta</h3>
              <p>Formatos permitidos: PDF, JPG, PNG.</p>
            </div>
            <div class="upload-actions">
              <button type="button" id="selectFiles" class="button ghost">Seleccionar archivos</button>
              <button type="button" id="selectFolder" class="button ghost">Seleccionar carpeta</button>
              <input type="file" id="fileInput" accept=".pdf,.jpg,.jpeg,.png" multiple />
              <input type="file" id="folderInput" accept=".pdf,.jpg,.jpeg,.png" webkitdirectory directory multiple />
            </div>
          </div>

          <div class="upload-table-wrapper">
            <table id="uploadTable">
              <thead>
                <tr>
                  <th>Archivo</th>
                  <th>Fecha</th>
                  <th>Proveedor</th>
                  <th>Base imponible</th>
                  <th>IVA</th>
                  <th>IVA (€)</th>
                  <th>Total (€)</th>
                  <th></th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
            <datalist id="supplierSuggestions"></datalist>
            <p class="empty" id="emptyMessage">No hay archivos pendientes.</p>
          </div>
        </section>

        <section class="panel invoices-panel">
          <div class="panel-header">
            <h2>Facturas guardadas</h2>
          </div>
          <div class="billing-table">
            <table id="invoicesTable">
              <thead>
                <tr>
                  <th>Fecha</th>
                  <th>Proveedor</th>
                  <th>Base (€)</th>
                  <th>IVA</th>
                  <th>IVA (€)</th>
                  <th>Total (€)</th>
                  <th>Tipo de gasto</th>
                  <th>Acciones</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
          <p class="empty" id="invoicesEmpty">No hay facturas para este período.</p>
        </section>
      </section>

      <section class="page-section" data-section="expenses">
        <section class="panel no-invoice-panel">
          <div class="panel-header">
            <h2>Gastos sin factura</h2>
            <p>Registra gastos deducibles o no deducibles sin documento fiscal.</p>
          </div>
          <div class="billing-form">
            <div class="field">
              <label for="noInvoiceDate">Fecha</label>
              <input type="date" id="noInvoiceDate" />
            </div>
            <div class="field">
              <label for="noInvoiceConcept">Concepto</label>
              <input type="text" id="noInvoiceConcept" placeholder="Ej. Nómina marzo" />
            </div>
            <div class="field">
              <label for="noInvoiceAmount">Importe (€)</label>
              <input type="number" id="noInvoiceAmount" min="0" step="0.01" placeholder="0,00" />
            </div>
            <div class="field is-hidden" id="noInvoiceInterestField">
              <label for="noInvoiceInterest">Interés (€)</label>
              <input type="number" id="noInvoiceInterest" min="0" step="0.01" placeholder="0,00" />
            </div>
            <div class="field">
              <label for="noInvoiceVatDeductible">IVA deducible</label>
              <select id="noInvoiceVatDeductible">
                <option value="false">No</option>
                <option value="true">Sí</option>
              </select>
            </div>
            <div class="field is-hidden" id="noInvoiceVatRateField">
              <label for="noInvoiceVatSelect">Tipo de IVA</label>
              <select id="noInvoiceVatSelect">
                <option value="0">0%</option>
                <option value="4">4%</option>
                <option value="10">10%</option>
                <option value="21">21%</option>
              </select>
            </div>
            <div class="field is-hidden" id="noInvoiceVatBaseField">
              <label for="noInvoiceVatBase">Base imponible (€)</label>
              <input
                type="number"
                id="noInvoiceVatBase"
                min="0"
                step="0.01"
                placeholder="0,00"
                readonly
              />
            </div>
            <div class="field is-hidden" id="noInvoiceVatAmountField">
              <label for="noInvoiceVatAmount">IVA deducible (€)</label>
              <input
                type="number"
                id="noInvoiceVatAmount"
                min="0"
                step="0.01"
                placeholder="0,00"
                readonly
              />
            </div>
            <div class="field">
              <label for="noInvoiceType">Tipo</label>
              <select id="noInvoiceType">
                <option value="nomina">Nómina</option>
                <option value="seguridad_social">Seguridad Social</option>
                <option value="amortizacion">Amortización</option>
                <option value="kilometraje">Kilometraje</option>
                <option value="prestamo">Préstamo bancario</option>
                <option value="otro">Otro</option>
              </select>
            </div>
            <div class="field">
              <label for="noInvoiceDeductible">Deducible</label>
              <select id="noInvoiceDeductible">
                <option value="true">Sí</option>
                <option value="false">No</option>
              </select>
            </div>
            <button id="noInvoiceSaveBtn" class="button primary">Guardar</button>
          </div>
          <div class="billing-entries">
            <h3>Entradas del periodo</h3>
            <div class="billing-table">
              <table id="noInvoiceTable">
                <thead>
                  <tr>
                    <th>Fecha</th>
                    <th>Concepto</th>
                    <th>Importe (€)</th>
                    <th>IVA</th>
                    <th>IVA (€)</th>
                    <th>Interés (€)</th>
                    <th>Tipo</th>
                    <th>Deducible</th>
                    <th>Acciones</th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>
            <p class="empty" id="noInvoiceEmpty">No hay gastos sin factura en este período.</p>
          </div>
        </section>
      </section>

      <section class="page-section" data-section="income">
        <section class="panel billing-panel">
          <div class="panel-header">
            <h2>Ingresos</h2>
            <p>Introduce facturación manual por tipo de IVA.</p>
          </div>
          <div class="billing-form">
            <div class="field">
              <label for="billingDateInput">Fecha</label>
              <input type="date" id="billingDateInput" />
            </div>
            <div class="field">
              <label for="billingConceptInput">Concepto</label>
              <input type="text" id="billingConceptInput" placeholder="Ej. Servicios de abril" />
            </div>
            <div class="field">
              <label for="billingMonthSelect">Mes de facturación</label>
              <select id="billingMonthSelect"></select>
            </div>
            <div class="field">
              <label for="billingYearSelect">Año de facturación</label>
              <select id="billingYearSelect"></select>
            </div>
            <div class="field">
              <label for="billingBaseInput">Base facturada (€)</label>
              <input type="number" id="billingBaseInput" min="0" step="0.01" placeholder="0,00" />
            </div>
            <div class="field">
              <label for="billingVatSelect">Tipo de IVA</label>
              <select id="billingVatSelect">
                <option value="0">0%</option>
                <option value="4">4%</option>
                <option value="10">10%</option>
                <option value="21">21%</option>
              </select>
            </div>
            <div class="field">
              <label for="billingVatAmountInput">IVA repercutido (€)</label>
              <input
                type="number"
                id="billingVatAmountInput"
                min="0"
                step="0.01"
                placeholder="0,00"
                readonly
              />
            </div>
            <div class="field">
              <label for="billingTotalInput">Total facturado (€)</label>
              <input type="number" id="billingTotalInput" min="0" step="0.01" placeholder="0,00" />
            </div>
            <button id="billingSaveBtn" class="button primary">Guardar</button>
          </div>
          <div class="billing-entries">
            <h3>Entradas del periodo</h3>
            <div class="billing-table">
              <table id="billingEntriesTable">
                <thead>
                  <tr>
                    <th class="period-month">Mes</th>
                    <th>Base facturada (€)</th>
                    <th>Tipo de IVA</th>
                    <th>IVA repercutido (€)</th>
                    <th>Acciones</th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>
            <p class="empty" id="billingEntriesEmpty">No hay entradas de facturación.</p>
          </div>
        </section>

        <section class="panel income-invoices-panel">
          <div class="panel-header">
            <div>
              <h2>Facturas emitidas</h2>
              <p>Sube facturas emitidas para registrar ingresos con IA.</p>
            </div>
            <button id="incomeUploadBtn" class="button primary">Guardar facturas emitidas</button>
          </div>
          <div class="upload-area" id="incomeDropZone">
            <div class="upload-copy">
              <h3>Arrastra y suelta</h3>
              <p>Formatos permitidos: PDF, JPG, PNG.</p>
            </div>
            <div class="upload-actions">
              <button type="button" id="incomeSelectFiles" class="button ghost">Seleccionar archivos</button>
              <input type="file" id="incomeFileInput" accept=".pdf,.jpg,.jpeg,.png" multiple />
            </div>
          </div>

          <div class="upload-table-wrapper">
            <table id="incomeUploadTable">
              <thead>
                <tr>
                  <th>Archivo</th>
                  <th>Fecha</th>
                  <th>Cliente</th>
                  <th>Base imponible</th>
                  <th>IVA</th>
                  <th>IVA (€)</th>
                  <th>Total (€)</th>
                  <th></th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
            <p class="empty" id="incomeEmptyMessage">No hay archivos pendientes.</p>
          </div>

          <div class="billing-entries">
            <h3>Facturas emitidas guardadas</h3>
            <div class="billing-table">
              <table id="incomeInvoicesTable">
                <thead>
                  <tr>
                    <th>Fecha</th>
                    <th>Cliente</th>
                    <th>Base (€)</th>
                    <th>IVA</th>
                    <th>IVA (€)</th>
                    <th>Total (€)</th>
                    <th>Acciones</th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>
            <p class="empty" id="incomeInvoicesEmpty">No hay facturas emitidas para este período.</p>
          </div>
        </section>
      </section>

      <section class="page-section" data-section="payments">
        <section class="panel payments-panel">
          <div class="panel-header">
            <div>
              <h2>Calendario de pagos</h2>
              <p>Consulta los vencimientos y los importes previstos por día.</p>
            </div>
          </div>
          <div class="calendar-toolbar">
            <button class="calendar-nav-btn" type="button" id="paymentPrevMonth" aria-label="Mes anterior">‹</button>
            <h3 id="paymentCalendarTitle"></h3>
            <button class="calendar-nav-btn" type="button" id="paymentNextMonth" aria-label="Mes siguiente">›</button>
          </div>
          <p id="paymentMonthTotal" class="payment-month-total"></p>
          <p id="paymentMonthEmpty" class="empty">Sin pagos previstos este mes.</p>
          <div id="paymentCalendar" class="calendar-wrapper"></div>
          <div class="payment-details">
            <h3 id="paymentDayTitle">Selecciona un día para ver el detalle</h3>
            <div id="paymentDayList" class="payment-day-list"></div>
            <p id="paymentDayTotal" class="payment-day-total"></p>
          </div>
        </section>
      </section>

      <section class="page-section" data-section="reports">
        <section class="panel report-panel">
          <div class="panel-header">
            <div>
              <h2>Informes trimestrales</h2>
              <p>Genera informes fiscales por trimestre o periodo personalizado.</p>
            </div>
          </div>
          <div class="report-form">
            <div class="field">
              <label for="reportYearSelect">Año</label>
              <select id="reportYearSelect"></select>
            </div>
            <div class="field">
              <label for="reportQuarterSelect">Periodo</label>
              <select id="reportQuarterSelect">
                <option value="1">T1</option>
                <option value="2">T2</option>
                <option value="3">T3</option>
                <option value="4">T4</option>
                <option value="custom">Personalizado</option>
              </select>
            </div>
            <div class="field">
              <label for="reportStartMonthSelect">Desde</label>
              <select id="reportStartMonthSelect"></select>
            </div>
            <div class="field">
              <label for="reportEndMonthSelect">Hasta</label>
              <select id="reportEndMonthSelect"></select>
            </div>
          </div>
          <div class="report-actions">
            <button id="reportDownloadBtn" class="button primary">Descargar informe</button>
            <button id="reportEmailBtn" class="button ghost">Enviar por email</button>
          </div>
          <p id="reportStatus" class="form-hint"></p>
        </section>
      </section>

      <section class="page-section" data-section="taxes">
        <section class="panel billing-summary-panel">
          <div class="panel-header">
            <div>
              <h2>Resumen de IVA</h2>
              <p>Datos consolidados del periodo seleccionado.</p>
            </div>
            <span class="period-badge" id="taxPeriodBadge"></span>
          </div>
          <div class="billing-table">
            <table id="billingTable">
              <thead>
                <tr>
                  <th>IVA</th>
                  <th>Total facturado (€)</th>
                  <th>IVA repercutido (€)</th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td>IVA 0%</td>
                  <td id="billingBase0">0,00 €</td>
                  <td id="billingVat0">0,00 €</td>
                </tr>
                <tr>
                  <td>IVA 4%</td>
                  <td id="billingBase4">0,00 €</td>
                  <td id="billingVat4">0,00 €</td>
                </tr>
                <tr>
                  <td>IVA 10%</td>
                  <td id="billingBase10">0,00 €</td>
                  <td id="billingVat10">0,00 €</td>
                </tr>
                <tr>
                  <td>IVA 21%</td>
                  <td id="billingBase21">0,00 €</td>
                  <td id="billingVat21">0,00 €</td>
                </tr>
              </tbody>
            </table>
          </div>
          <div class="vat-result">
            <div class="vat-card">
              <h3>Total IVA repercutido</h3>
              <p id="vatOutputTotal">0,00 €</p>
            </div>
            <div class="vat-card">
              <h3>Total IVA soportado</h3>
              <p id="vatInputTotal">0,00 €</p>
            </div>
            <div class="vat-card result">
              <h3 id="vatResultLabel">IVA A PAGAR</h3>
              <p id="vatResultValue">0,00 €</p>
            </div>
          </div>
        </section>

        <section class="panel tax-panel" data-tax-module="irpf">
          <div class="panel-header">
            <h2>Resumen IRPF (anual)</h2>
            <p>Resultado anual estimado, independiente del mes o trimestre seleccionado.</p>
          </div>
          <div class="vat-result">
            <div class="vat-card">
              <h3>Ingresos base anuales</h3>
              <p id="irpfIncome">0,00 €</p>
            </div>
            <div class="vat-card">
              <h3>Gastos deducibles anuales</h3>
              <p id="irpfExpenses">0,00 €</p>
            </div>
            <div class="vat-card result">
              <h3>Rendimiento neto anual estimado</h3>
              <p id="irpfNet">0,00 €</p>
            </div>
          </div>
        </section>

        <section class="panel tax-panel" data-tax-module="is">
          <div class="panel-header">
            <h2>Resumen Impuesto de Sociedades (anual)</h2>
            <p>Resultado anual estimado con tipo general del 25%.</p>
          </div>
          <div class="vat-result">
            <div class="vat-card">
              <h3>Ingresos base anuales</h3>
              <p id="isIncome">0,00 €</p>
            </div>
            <div class="vat-card">
              <h3>Gastos deducibles anuales</h3>
              <p id="isExpenses">0,00 €</p>
            </div>
            <div class="vat-card result">
              <h3>Resultado anual estimado</h3>
              <p id="isResult">0,00 €</p>
            </div>
            <div class="vat-card">
              <h3>Base imponible anual estimada</h3>
              <p id="isBase">0,00 €</p>
            </div>
          </div>
        </section>
      </section>

      <section class="page-section" data-section="pnl">
        <section class="panel pnl-panel">
          <div class="panel-header">
            <div>
              <h2>Cuenta de pérdidas y ganancias (estimada)</h2>
              <p>Cuenta de resultados estimada para el periodo seleccionado.</p>
            </div>
            <button id="exportPnlBtn" class="button primary">Exportar PDF</button>
          </div>

          <div class="pnl-form">
            <div class="field">
              <label for="pnlName">Nombre / Razón social</label>
              <input type="text" id="pnlName" placeholder="Ej. Consultoría Norte SL" />
            </div>
            <div class="field">
              <label for="pnlTaxId">CIF / NIF</label>
              <input type="text" id="pnlTaxId" placeholder="Ej. B12345678" />
            </div>
          </div>

          <div class="billing-table">
            <table id="pnlTable">
              <thead>
                <tr>
                  <th>Concepto</th>
                  <th>Importe (€)</th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td>1. Importe neto de la cifra de negocios</td>
                  <td><input class="pnl-input" id="pnlLine1" type="number" step="0.01" /></td>
                </tr>
                <tr>
                  <td>2. Variación de existencias de productos terminados y en curso</td>
                  <td><input class="pnl-input" id="pnlLine2" type="number" step="0.01" /></td>
                </tr>
                <tr>
                  <td>3. Trabajos realizados por la empresa para su activo</td>
                  <td><input class="pnl-input" id="pnlLine3" type="number" step="0.01" /></td>
                </tr>
                <tr>
                  <td>4. Aprovisionamientos</td>
                  <td><input class="pnl-input" id="pnlLine4" type="number" step="0.01" /></td>
                </tr>
                <tr>
                  <td>5. Otros ingresos de explotación</td>
                  <td><input class="pnl-input" id="pnlLine5" type="number" step="0.01" /></td>
                </tr>
                <tr>
                  <td>6. Gastos de personal</td>
                  <td><input class="pnl-input" id="pnlLine6" type="number" step="0.01" /></td>
                </tr>
                <tr>
                  <td>7. Otros gastos de explotación</td>
                  <td><input class="pnl-input" id="pnlLine7" type="number" step="0.01" /></td>
                </tr>
                <tr>
                  <td>8. Amortización del inmovilizado</td>
                  <td><input class="pnl-input" id="pnlLine8" type="number" step="0.01" /></td>
                </tr>
                <tr>
                  <td>9. Imputación de subvenciones de inmovilizado no financiero y otras</td>
                  <td><input class="pnl-input" id="pnlLine9" type="number" step="0.01" /></td>
                </tr>
                <tr>
                  <td>10. Excesos de provisiones</td>
                  <td><input class="pnl-input" id="pnlLine10" type="number" step="0.01" /></td>
                </tr>
                <tr>
                  <td>11. Deterioro y resultado por enajenación del inmovilizado</td>
                  <td><input class="pnl-input" id="pnlLine11" type="number" step="0.01" /></td>
                </tr>
                <tr>
                  <td>12. Otros resultados</td>
                  <td><input class="pnl-input" id="pnlLine12" type="number" step="0.01" /></td>
                </tr>
                <tr class="pnl-total">
                  <td><strong>A) RESULTADO DE EXPLOTACIÓN</strong></td>
                  <td><strong id="pnlOperatingResult">0,00 €</strong></td>
                </tr>
                <tr>
                  <td>13. Ingresos financieros</td>
                  <td></td>
                </tr>
                <tr>
                  <td class="pnl-indent">a) Imputación de subvenciones, donaciones y legados de carácter financiero</td>
                  <td><input class="pnl-input" id="pnlLine13a" type="number" step="0.01" /></td>
                </tr>
                <tr>
                  <td class="pnl-indent">b) Otros ingresos financieros</td>
                  <td><input class="pnl-input" id="pnlLine13b" type="number" step="0.01" /></td>
                </tr>
                <tr>
                  <td>14. Gastos financieros</td>
                  <td><input class="pnl-input" id="pnlLine14" type="number" step="0.01" /></td>
                </tr>
                <tr>
                  <td>15. Variación de valor razonable en instrumentos financieros</td>
                  <td><input class="pnl-input" id="pnlLine15" type="number" step="0.01" /></td>
                </tr>
                <tr>
                  <td>16. Diferencias de cambio</td>
                  <td><input class="pnl-input" id="pnlLine16" type="number" step="0.01" /></td>
                </tr>
                <tr>
                  <td>17. Deterioro y resultado por enajenación de instrumentos financieros</td>
                  <td><input class="pnl-input" id="pnlLine17" type="number" step="0.01" /></td>
                </tr>
                <tr>
                  <td>18. Otros ingresos y gastos de carácter financiero</td>
                  <td></td>
                </tr>
                <tr>
                  <td class="pnl-indent">a) Incorporación al activo de gastos financieros</td>
                  <td><input class="pnl-input" id="pnlLine18a" type="number" step="0.01" /></td>
                </tr>
                <tr>
                  <td class="pnl-indent">b) Ingresos financieros derivados de convenios de acreedores</td>
                  <td><input class="pnl-input" id="pnlLine18b" type="number" step="0.01" /></td>
                </tr>
                <tr>
                  <td class="pnl-indent">c) Resto de ingresos y gastos</td>
                  <td><input class="pnl-input" id="pnlLine18c" type="number" step="0.01" /></td>
                </tr>
                <tr class="pnl-total">
                  <td><strong>B) RESULTADO FINANCIERO</strong></td>
                  <td><strong id="pnlFinancialResult">0,00 €</strong></td>
                </tr>
                <tr class="pnl-total">
                  <td><strong>C) RESULTADO ANTES DE IMPUESTOS</strong></td>
                  <td><strong id="pnlPreTax">0,00 €</strong></td>
                </tr>
                <tr>
                  <td>19. Impuestos sobre beneficios</td>
                  <td><input class="pnl-input" id="pnlLine19" type="number" step="0.01" /></td>
                </tr>
                <tr class="pnl-total">
                  <td><strong>D) RESULTADO DEL EJERCICIO</strong></td>
                  <td><strong id="pnlNet">0,00 €</strong></td>
                </tr>
              </tbody>
            </table>
          </div>
          <p class="pnl-note">
            Estructura basada en el Plan General Contable PYMES. Importes estimados automáticamente y no sustitutivos del asesoramiento fiscal profesional.
          </p>
        </section>
      </section>

      <footer class="legal-footer app-footer">
        <div class="footer-brand">
          <span class="brand-mark" aria-hidden="true">
            <svg viewBox="0 0 40 40" role="img" focusable="false">
              <rect x="4" y="4" width="32" height="32" rx="8"></rect>
              <rect x="12" y="10" width="6" height="6" rx="2" fill="var(--panel)"></rect>
              <rect x="12" y="20" width="6" height="6" rx="2" fill="var(--panel)"></rect>
              <rect x="22" y="10" width="12" height="16" rx="3" fill="var(--panel)"></rect>
            </svg>
          </span>
          <span>© 2026 Ledged · Contacto: soporte@ledged.app</span>
        </div>
        <div class="legal-links">
          <a href="{{ url_for('legal_notice') }}">Aviso legal</a>
          <a href="{{ url_for('privacy') }}">Política de privacidad</a>
          <a href="{{ url_for('cookies') }}">Política de cookies</a>
          <a href="{{ url_for('terms') }}">Términos del servicio</a>
        </div>
      </footer>
    </main>
  </div>

  <div class="modal-overlay" id="lowQualityModal" aria-hidden="true">
    <div class="modal-card" role="dialog" aria-modal="true" aria-labelledby="lowQualityTitle">
      <button class="modal-close" type="button" id="lowQualityClose" aria-label="Cerrar">×</button>
      <h3 id="lowQualityTitle">Aviso de lectura</h3>
      <p>
        La calidad de la factura escaneada no es óptima.<br />
        No se puede leer correctamente.<br />
        Por favor, introduce los datos manualmente.
      </p>
      <button class="button" type="button" id="lowQualityAccept">Aceptar</button>
    </div>
  </div>

  <script src="{{ url_for('static', filename='js/chart.min.js') }}"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
  <script src="{{ url_for('static', filename='js/app.js') }}"></script>
</body>
</html>
